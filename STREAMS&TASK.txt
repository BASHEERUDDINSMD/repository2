STREAM & TASKS 
END TO END DATALOAD 
FROM AWS S3 TO STAGING TABLE USING SNOWPIPE
FROM STAGING DB TO TARGET DB USING STREAMS & TASKS

STREAM ---> LOAD INTO TARGET TABLE USING COPY COMMAND 

TASKS --> SCHEDULE OUR COPY COMMAND 

STEPS:
CREATED STREAMS ON TOP OF YOUR STG TABLE
USING SNOWPIPE LOADED DATA INTO STAGING TABLE  
 CREATED TARGET TABLE TARGET DB 
 CREATED STORED PROC IN STG DB 
 CREATE TASK 
 LOAD STREAM DATA INTO TARGET DB 


USE ROLE SYSADMIN;
USE ROLE ACCOUNTADMIN;
USE WAREHOUSE SHAIK_WH;
USE DATABASE HYD_STG;
USE SCHEMA DATA_LOADS;
SHOW STAGES;
LIST @SHAIK_SAMPLE_STAGE;
SHOW PIPES;
SELECT SYSTEM$PIPE_STATUS('TEST_PIPE');

select * from table(information_schema.copy_history(table_name=>'"HYD_STG"."DATA_LOADS"."CATALOG_STG"', start_time=> dateadd(hours, -6, current_timestamp())));
SELECT * FROM TABLE(VALIDATE_PIPE_LOAD(PIPE_NAME=>'"HYD_STG"."DATA_LOADS"."TEST_PIPE"',START_TIME=>DATEADD(HOUR,-3,CURRENT_TIMESTAMP())));

CREATE OR REPLACE STREAM "HYD_STG"."DATA_LOADS"."CATALOG_STREAM" ON TABLE "HYD_STG"."DATA_LOADS"."CATALOG_STG"
APPEND_ONLY = TRUE;

SHOW STREAMS;

SELECT SYSTEM$STREAM_HAS_DATA('"HYD_STG"."DATA_LOADS"."CATALOG_STREAM"');

--CREATING STORED PROCEDURE TO LOAD FROM STREAM TO TARGET DB TABLE

--JavaScript compilation error: Uncaught SyntaxError: Unexpected identifier in CATALOGUE_STG_TARGET at 'VAR STREAM_SELECT_CMD = '' position 4

CREATE OR REPLACE TASK "HYD_STG"."DATA_LOADS"."CATALOG_STG_TASK"
WAREHOUSE = SHAIK_WH
SCHEDULE = '2 MINUTES'
WHEN 
SYSTEM$STREAM_HAS_DATA('"HYD_STG"."DATA_LOADS"."CATALOG_STREAM"')
AS
--CALL CATALOGUE_STG_TARGET();
INSERT INTO "HYD"."DATA_LOADS"."CATALOG_TABLE"
SELECT
	CP_CATALOG_PAGE_SK,
	CP_CATALOG_PAGE_ID,
	CP_START_DATE_SK,
	CP_END_DATE_SK,
	CP_DEPARTMENT,
	CP_CATALOG_NUMBER,
	CP_CATALOG_PAGE_NUMBER,
	CP_DESCRIPTION,    
	CP_TYPE
 FROM "HYD_STG"."DATA_LOADS"."CATALOG_STREAM"
WHERE METADATA$ACTION = 'INSERT';

SHOW TASKS;

GRANT EXECUTE TASK ON ACCOUNT TO SYSADMIN;
ALTER TASK "HYD_STG"."DATA_LOADS"."CATALOG_STG_TASK" RESUME;
ALTER TASK "HYD_STG"."DATA_LOADS"."CATALOG_STG_TASK" SUSPEND;

select * from table(information_schema.task_history(scheduled_time_range_start=>dateadd('hour',-2,current_timestamp()), 
                                                    task_name=>'CATALOG_STG_TASK')); 
                                                    
SELECT COUNT(*) FROM "HYD"."DATA_LOADS"."CATALOG_TABLE";

-------------------------------------------------------------------------------------------------------------------

CREATE OR REPLACE PROCEDURE CATALOGUE_STG_TARGET()
RETURNS STRING NOT NULL
LANGUAGE JAVASCRIPT
EXECUTE AS CALLER
AS
$$
VAR STREAM_SELECT_CMD = '
INSERT INTO "HYD"."DATALOADS"."CATALOG_TABLE"
SELECT
	CP_CATALOG_PAGE_SK::NUMBER(38,0),
	CP_CATALOG_PAGE_ID::VARCHAR(16),
	CP_START_DATE_SK::NUMBER(38,0),
	CP_END_DATE_SK::NUMBER(38,0),
	CP_DEPARTMENT::VARCHAR(50),
	CP_CATALOG_NUMBER::NUMBER(38,0),
	CP_CATALOG_PAGE_NUMBER::NUMBER(38,0),
	CP_DESCRIPTION VARCHAR(100),    
	CP_TYPE::VARCHAR(100)
 FROM 
"HYD_STG"."DATA_LOADS"."CATALOG_TREAM"
WHERE
METADAT$ACTION = 'INSERT';
'

VAR SQL_SELECT_STREAM = SNOWFLAKE.CREATESTATEMENT({SQLTEXT:STREAM_SELECT_CMD});
VAR STREAM_SELECT_RESULTS = SQL_SELECT_STREAM.EXECUTE();
RETURN'??'
$$;



-------------------------------------------

SELECT
	CP_CATALOG_PAGE_SK::NUMBER(38,0),
	CP_CATALOG_PAGE_ID::VARCHAR(16),
	CP_START_DATE_SK::NUMBER(38,0),
	CP_END_DATE_SK::NUMBER(38,0),
	CP_DEPARTMENT::VARCHAR(50),
	CP_CATALOG_NUMBER ::NUMBER(38,0),
	CP_CATALOG_PAGE_NUMBER ::NUMBER(38,0),
	CP_DESCRIPTION ::VARCHAR(100),
	CP_TYPE ::VARCHAR(100)
